<canvas id="canvas"></canvas><br>
<button onclick="start()">Start</button>

<script src="https://raw.githack.com/bennyschudel/JSManipulate/0a6f6c236bbe8456870f3da1af6c5055ab210270/script/jsmanipulate.js"></script>
<script>
async function start() {
  const ctx = window.canvas.getContext('2d');
  const mediaStream = await navigator.mediaDevices.getDisplayMedia({video: true});

  const memVideo = document.createElement('video');
  memVideo.srcObject = mediaStream;
  await memVideo.play();

  const width = memVideo.videoWidth;
  const height = memVideo.videoHeight;
  const memCanvas = document.createElement('canvas');
  window.canvas.width = memCanvas.width = width;
  window.canvas.height = memCanvas.height = height;
  const memCtx = memCanvas.getContext('2d');

  (function loop(){
    memCtx.drawImage(memVideo, 0, 0, width, height);
    const frame = memCtx.getImageData(0, 0, width, height);

    JSManipulate.sepia.filter(frame);
    ctx.putImageData(frame, 0, 0);
    setTimeout(loop, 0);
  })();

  console.log()
  const mediaStream2 = window.canvas.captureStream()

  const readableStream = mediaStreamToReadableStream(mediaStream2, 100);

  fetch("https://ppng.io/myvideo", {
    method: 'POST',
    body: readableStream,
    allowHTTP1ForStreamingUpload: true,
  });
}

function blobToUint8Array(blob) {
  return new Promise((resolve, reject) => {
    const fileReader = new FileReader();
    fileReader.onload = () => resolve(new Uint8Array(fileReader.result));
    fileReader.onerror = reject;
    fileReader.readAsArrayBuffer(blob);
  });
}

function mediaStreamToReadableStream(mediaStream, timeslice) {
  return new ReadableStream({
    start(ctrl){
      const recorder = new MediaRecorder(mediaStream);
      recorder.ondataavailable = async (e) => {
        ctrl.enqueue(await blobToUint8Array(e.data));
      };
      recorder.start(timeslice);
    }
  });
}
</script>
